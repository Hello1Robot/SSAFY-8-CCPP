# âœ¨ JPA N+1

### ğŸ“Œ N+1 ì´ë€?

- ì—°ê´€ ê´€ê³„ê°€ ì„¤ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ê²½ìš°ì— ì¡°íšŒëœ ë°ì´í„° ê°¯ìˆ˜ (N) ë§Œí¼ì˜ ì—°ê´€ê´€ê³„ì˜ ì¡°íšŒ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ì—¬ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” í˜„ìƒ
- ë³´í†µ `@OneToMany` ì—ì„œ ë§ì´ ì¼ì–´ë‚œë‹¤.



### ğŸ“Œ ìƒí™©

```java
@Entity
public class User {
    @Id
    @GeneratedValue
    private long id;
    private String firstName;
    private String lastName;

    @ManyToOne(fetch = FetchType.EAGER)		// ì¦‰ì‹œ ë¡œë”©
    @JoinColumn(name = "team_id", nullable = false)
    private Team team;
}
```

```java
@Entity
public class Team {
    @Id
    @GeneratedValue
    private long id;
    private String name;
		
  	// ì—¬ê¸° ì´ ë¶€ë¶„ !!
    @OneToMany(fetch = FetchType.EAGER)
    private List<User> users = new ArrayList<>();
}
```

```java
teamRepository.findAll();
```

```sql
// team 
Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?
```



- JPA ê°€ JPQLì„ ë¶„ì„í•´ì„œ SQLì„ ìƒì„±í•  ë•ŒëŠ” ê¸€ë¡œë²Œ Fetch ì „ëµì„ ì°¸ê³ í•˜ì§€ ì•Šê³  ì˜¤ì§ JPQL ìì²´ë§Œì„ ì‚¬ìš©í•œë‹¤.

#### 1. ì¦‰ì‹œ(Eager) ë¡œë”©

1. `findAll()`ì„ í•œ ìˆœê°„ `select t from Team t` ë¼ëŠ” JPQL êµ¬ë¬¸ì´ ìƒì„±ë˜ê³  í•´ë‹¹ êµ¬ë¬¸ì„ ë¶„ì„í•œ `select * from team` ì´ë¼ëŠ” SQLì´ ìƒì„±ë˜ì–´ ì‹¤í–‰ëœë‹¤. 

2. DB ì˜ ê²°ê³¼ë¥¼ ë°›ì•„ team Entityì˜ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ìƒì„±í•œë‹¤.
3. teamê³¼ ì—°ê´€ë˜ì–´ ìˆëŠ” userë„ ë¡œë”©ì„ í•´ì•¼ í•œë‹¤.
4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—°ê´€ëœ userê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
5. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ë‹¤ë©´ `2`ì—ì„œ ë§Œë“¤ì–´ì§„ teamì¸ìŠ¤í„´ìŠ¤ë“¤ ê°œìˆ˜ì— ë§ê²Œ `select * from user where team_id = ?` ì´ë¼ëŠ” SQL êµ¬ë¬¸ì´ ìƒì„±ëœë‹¤. (N+1 ë°œìƒ)

- ì¦‰, Teamì„ ê²€ìƒ‰í•˜ê³  ì‹¶ì–´ì„œ select ì¿¼ë¦¬ë¥¼ í•˜ë‚˜ ë‚ ë ¸ì§€ë§Œ, ì¦‰ì‹œ ë¡œë”©ì´ ê±¸ë ¤ìˆê¸° ë•Œë¬¸ì— ê° Teamì´ ê°€ì§„ User ë„ ëª¨ë‘ ê²€ìƒ‰í•œë‹¤ ë¼ëŠ” N+1 ë¬¸ì œê°€ ë°œìƒ





#### 2. ì§€ì—°(Lazy) ë¡œë”©

- ì—°ê´€ëœ ê°ì²´ë¥¼ **ì‚¬ìš©í•˜ëŠ” ì‹œì **ì— ë¡œë”©ì„ í•´ì£¼ëŠ” ë°©ë²•
- ì§€ì—° ë¡œë”©ì€ í•´ë‹¹ ì—°ê²° Entityì— ëŒ€í•´ í”„ë¡ì‹œë¡œ ê±¸ì–´ë‘ê³ , ì‚¬ìš©í•  ë•Œ ê²°êµ­ ë‚ ë¦¬ê¸° ë•Œë¬¸ì— ì²˜ìŒ findí•  ë•ŒëŠ” N+1ì´ ë°œìƒí•˜ì§€ ì•Šì§€ë§Œ ì¶”ê°€ë¡œ Teamì„ ê²€ìƒ‰ í›„, Teamì˜ Userë¥¼ ì°¾ì•„ì•¼ í•œë‹¤ë©´ ë˜ ë‹¤ì‹œ í”„ë¡ì‹œì— ëŒ€í•œ ì¿¼ë¦¬ ë°œìƒ.
- Team ê²€ìƒ‰ í›„ í•„ë“œë¥¼ ê²€ìƒ‰í•  ë•Œ N+1 ë¬¸ì œ ë°œìƒ

1. `findAll()` ì„ í•œ ìˆœê°„ `select t from Team t` ì´ë¼ëŠ” JPQL êµ¬ë¬¸ì´ ìƒì„±ë˜ê³  í•´ë‹¹ êµ¬ë¬¸ì„ ë¶„ì„í•œ `select * from team` ì´ë¼ëŠ” SQLì´ ìƒì„±ë˜ì–´ ì‹¤í–‰ëœë‹¤. 
2. DB ì˜ ê²°ê³¼ë¥¼ ë°›ì•„ team Entityì˜ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ìƒì„±í•œë‹¤.
3. ì½”ë“œ ì¤‘ì—ì„œ team ì˜ user ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•˜ëŠ” ì‹œì ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—°ê´€ëœ userê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ë‹¤ë©´ `2` ì—ì„œ ë§Œë“¤ì–´ì§„ team ì¸ìŠ¤í„´ìŠ¤ë“¤ ê°œìˆ˜ì— ë§ê²Œ `select * from user where team_id = ?` ì´ë¼ëŠ” SQL êµ¬ë¬¸ì´ ìƒì„±ëœë‹¤. (N+1 ë°œìƒ)



- JPAê°€ ìë™ìœ¼ë¡œ ë¨¼ì € ìƒì„±í•´ì£¼ëŠ” Jpqlì„ í†µí•´ì„œ ìš°ì„ ì ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ë‹¤ë³´ë‹ˆ ì—°ê´€ê´€ê³„ê°€ ê±¸ë ¤ìˆì–´ë„ joinì´ ë°”ë¡œ ê±¸ë¦¬ì§€ ì•ŠëŠ”ë‹¤.



### ğŸ“Œ í•´ê²°ë°©ë²•

#### 1. Fetch Join 

- N+1 ìì²´ê°€ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” í•œìª½ í…Œì´ë¸”ë§Œ ì¡°íšŒí•˜ê³  ì—°ê²°ëœ ë‹¤ë¥¸ í…Œì´ë¸”ì€ ë”°ë¡œ ì¡°íšŒí•˜ê¸° ë•Œë¬¸
- ë¯¸ë¦¬ ë‘ í…Œì´ë¸”ì„ Join í•˜ì—¬ í•œ ë²ˆì— ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤ë©´ N+1 ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šì„ ê²ƒì´ë¼ ìƒê°í•˜ì—¬ ë‚˜ì˜¨ ë°©ë²•

```java
public interface TeamRepository extends JpaRepository<Team, Long> {
    @Query("select t from Team t join fetch t.users")
    List<Team> findAllFetchJoin();
}
```

```sql
Hibernate: select team0_.id as id1_0_0_, user2_.id as id1_2_1_, team0_.name as name2_0_0_, user2_.first_name as first_na2_2_1_, user2_.last_name as last_nam3_2_1_, user2_.team_id as team_id4_2_1_, users1_.team_id as team_id1_1_0__, users1_.users_id as users_id2_1_0__ from team team0_ inner join team_users users1_ on team0_.id=users1_.team_id inner join user user2_ on users1_.users_id=user2_.id
```

- INNER JOIN ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ê²ƒ í™•ì¸ ê°€ëŠ¥
- í•˜ì§€ë§Œ Fetch Joinì„ í•˜ê²Œ ë˜ë©´ ë°ì´í„° í˜¸ì¶œ ì‹œì ì— ëª¨ë“  ì—°ê´€ê´€ê³„ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ì—°ê´€ê´€ê³„ ì„¤ì •í•´ë†“ì€ Fetch Typeì´ ë¬´ì˜ë¯¸ í•´ì§
- í˜ì´ì§• ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ. í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¬¸ìœ¼ë¡œ ê°€ì ¸ì˜¤ë¯€ë¡œ í˜ì´ì§• ë‹¨ìœ„ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒ ë¶ˆê°€ëŠ¥



#### 2. `@Entitygraph`

- `@Entitygraph` ì˜ `attributePaths` ì— ì¿¼ë¦¬ ìˆ˜í–‰ ì‹œ ë°”ë¡œ ê°€ì ¸ì˜¬ í•„ë“œëª…ì„ ì§€ì •í•˜ë©´ Lazyê°€ ì•„ë‹Œ Eager ì¡°íšŒë¡œ ê°€ì ¸ì˜¤ê²Œ ë¨. 
- Fetch Join ê³¼ ë™ì¼í•˜ê²Œ JPQL ì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ë¬¸ì„ ì‘ì„±í•˜ê³  í•„ìš”í•œ ì—°ê´€ê´€ê³„ë¥¼ Entitygraph ì— ì„¤ì •í•˜ë©´ ëœë‹¤.

- Fetch Join ê³¼ëŠ” ë‹¤ë¥´ê²Œ Outer Join ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.

```java
@EntityGraph(attributePaths = "users")
@Query("select t from Team t")
List<Team> findAllEntityGraph();
```



### - Fetch Joinê³¼ EntityGraph ì£¼ì˜ì 

- ì¹´í…Œì‹œì•ˆ ê³±ì´ ë°œìƒí•˜ì—¬ Teamì˜ ìˆ˜ ë§Œí¼ userê°€ ì¤‘ë³µ ë°ì´í„°ê°€ ì¡´ì¬í•  ìˆ˜ ìˆë‹¤. 
- Set ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ì¤‘ë³µì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ìë£Œêµ¬ì¡° ì´ë¯€ë¡œ ì¤‘ë³µëœ ë°ì´í„°ë¥¼ ì œê±°í•  ìˆ˜ ìˆë‹¤. 



### 3. Batch Size

- ì§€ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ì§€ì •ëœ size ë§Œí¼ SQL ì˜ IN ì ˆì„ ì‚¬ìš©í•´ì„œ ì¡°íšŒ
- row ê°¯ìˆ˜ë§Œí¼ ì¶”ê°€ SQLì„ ë‚ ë¦¬ì§€ ì•Šê³ , ì¡°íšŒí•œ Teamì˜ idë“¤ì„ ëª¨ì•„ì„œ SQL IN ì ˆì„ ë‚ ë¦°ë‹¤.

```yaml
spring:
  jpa:
    properties:
      hibernate:
        default_batch_fetch_size: 1000
```

```sql
Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_
Hibernate: select users0_.team_id as team_id1_1_1_, users0_.users_id as users_id2_1_1_, user1_.id as id1_2_0_, user1_.first_name as first_na2_2_0_, user1_.last_name as last_nam3_2_0_, user1_.team_id as team_id4_2_0_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id in (?, ?, ?, ?)
```

- **EAGERì¸ ê²½ìš° ì²« ì¡°íšŒ ì‹œ BatchSizeë§Œí¼ ëŠì–´ì„œ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¡œ ì¡°íšŒ**í•˜ê²Œ ë˜ê³ , LAZYì¸ ê²½ìš° ì¶”í›„ ì‚¬ìš©í•  ë•Œ BatchSizeë§Œí¼ ëŠì–´ì„œ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¡œ ì¡°íšŒ



### ğŸ“Œ ì°¸ê³ 

https://velog.io/@jinyoungchoi95/JPA-%EB%AA%A8%EB%93%A0-N1-%EB%B0%9C%EC%83%9D-%EC%BC%80%EC%9D%B4%EC%8A%A4%EA%B3%BC-%ED%95%B4%EA%B2%B0%EC%B1%85

 https://dev-coco.tistory.com/165

https://incheol-jung.gitbook.io/docs/q-and-a/spring/n+1