# âœ¨ AOP

### ğŸ“Œ AOP ( Aspect Oriented Programming )

- ê´€ì  ì§€í–¥ í”„ë¡œê·¸ë˜ë°

- ì—¬ëŸ¬ ì˜¤ë¸Œì íŠ¸ì— ë‚˜íƒ€ë‚˜ëŠ” **ê³µí†µì ì¸ ë¶€ê°€ ê¸°ëŠ¥**ì„ **ëª¨ë“ˆí™”**í•˜ì—¬ **ì¬ì‚¬ìš©**í•˜ëŠ” ê¸°ë²•



### ğŸ“Œ í•µì‹¬ê¸°ëŠ¥ê³¼ ë¶€ê°€ê¸°ëŠ¥

<img src="./image-20230319232730055.png" alt="image-20230319232730055" style="zoom:50%;" />

- ì—…ë¬´ ë¡œì§ì„ í¬í•¨í•˜ëŠ” ê¸°ëŠ¥ì„ **í•µì‹¬ ê¸°ëŠ¥** (Core Concerns)
- í•µì‹¬ê¸°ëŠ¥ì„ ë„ì™€ì£¼ëŠ” **ë¶€ê°€ì ì¸ ê¸°ëŠ¥** (ì£¼ë¡œ ì„±ëŠ¥ê²€ì‚¬, íŠ¸ë™ì­ì…˜ ì²˜ë¦¬, ë¡œê¹…, ë³´ì•ˆ ë“±) (Cross-cutting Concerns) 
- ì´ëŸ¬í•œ ê³µí†µì ì¸ ë¶€ê°€ì ì¸ ê¸°ëŠ¥ë“¤ì„ **íš¡ë‹¨ ê´€ì‹¬ì‚¬**ë¼ê³  í•¨
- í•µì‹¬ê¸°ëŠ¥ì—ì„œ ë¶€ê°€ê¸°ëŠ¥ì„ ë¶„ë¦¬í•´ì„œ ëª¨ë“ˆí™”í•˜ëŠ” í”„ë¡œê·¸ë˜ë° ê¸°ë²• â†’ **AOP**

```
ë¡œê·¸ë¥¼ ë‚¨ê¸°ê±°ë‚˜, í•µì‹¬ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ë•Œ ì¸ì¦, ì¸ê°€ë¥¼ í•œë‹¤ë˜ê°€, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ë¥¼ í•˜ëŠ” ì‘ì—…ì€ ëª¨ë“  í•µì‹¬ê¸°ëŠ¥ì— ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ê¸°ëŠ¥ì´ë‹¤. AOPëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‚˜íƒ€ë‚´ëŠ” í•µì‹¬ê¸°ëŠ¥ì„ ì‘ì„±í•  ë•Œë§ˆë‹¤ ê³µí†µì ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ë¶€ê°€ê¸°ëŠ¥ì„ ë¶„ë¦¬í•´ì„œ í”„ë¡œê·¸ë˜ë°í•˜ëŠ” ê¸°ë²•ì´ë‹¤.
```



### ğŸ“Œ AOP ì˜ ì¥ì 

- í•µì‹¬ ê¸°ëŠ¥ ì„œë¹„ìŠ¤ë¥¼ ì œì™¸í•œ íš¡ë‹¨ê´€ì‹¬ì‚¬í•­ ì„œë¹„ìŠ¤ë¥¼ ë³„ë„ì˜ ëª¨ë“ˆì—ì„œ ê°œë°œí•˜ì—¬ ì ìš©í•˜ë¯€ë¡œ, ì—¬ëŸ¬ ì„œë¹„ìŠ¤ì— ê±¸ì³ìˆëŠ” ë°˜ë³µì  ì‘ì—…ì„ ì¤„ì¼ ìˆ˜ ìˆì–´ **ìƒì‚°ì„±ì´ ë†’ì•„ì§„ë‹¤.**
- ìš”êµ¬ì‚¬í•­ ë³€ê²½ ì‹œì—ë„ ìœ ì—°í•˜ê²Œ ëŒ€ì²˜í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, **ìœ ì§€ë³´ìˆ˜ì„±ì´ ë†’ì•„ì§„ë‹¤.**



### ğŸ“Œ AOP  ì£¼ìš” ìš©ì–´

- **Aspect**

  - AOP ì˜ ë‹¨ìœ„ê°€ ë˜ëŠ” íš¡ë‹¨ê´€ì‹¬ì‚¬ë¥¼ ì˜ë¯¸ ex) ë¡œê¹…, íŠ¸ë™ì­ì…˜ê´€ë¦¬ ë“±

    <img src="./image-20230319235824718.png" alt="image-20230319235824718" style="zoom: 50%;" />

- **JoinPoint**

  - íš¡ë‹¨ê´€ì‹¬ì‚¬ê°€ ì‹¤í–‰ë  ì§€ì 
  - **ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ** (ìŠ¤í”„ë§ AOPì—ì„œ)

- **Advice**

  - íš¡ë‹¨ê´€ì‹¬ì‚¬ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„, íŠ¹ì • JoinPointì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ
  - **ì–´ë–¤ ë¶€ê°€ê¸°ëŠ¥**ì„, **ì–¸ì œ** ?

- **Pointcut**

  - ì—¬ëŸ¬ JoinPoint ì¤‘ ì‹¤ì œ Adviceë¥¼ ì ìš©í•  ê³³ì„ ì„ ë³„í•˜ê¸° ìœ„í•œ í‘œí˜„ì‹

- **Weaving**

  - ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ì ì ˆí•œ ì§€ì ì— aspectë¥¼ ì ìš©í•˜ëŠ” ê²ƒì„ ë§í•¨

- **Target**

  - Aspectê°€ ì ìš©ëœ ê°ì²´ë¥¼ ë§í•œë‹¤.
  - ex) í´ë˜ìŠ¤, ë©”ì„œë“œ ..

  

### ğŸ“Œ AOP Advice ìœ í˜•

- **Before**
  - ë©”ì„œë“œ ì‹¤í–‰ ì „ì— ì‹¤í–‰í•˜ëŠ” Advice
- **After Returning**
  - ë©”ì„œë“œ ì •ìƒ ì‹¤í–‰ í›„ ì‹¤í–‰í•˜ëŠ” Advice
- **After Throwing**
  - ë©”ì„œë“œ ì‹¤í–‰ì‹œ ì˜ˆì™¸ ë°œìƒì‹œ ì‹¤í–‰í•˜ëŠ” Advice
- **After**
  - ë©”ì„œë“œ ì •ìƒ ì‹¤í–‰ ë˜ëŠ” ì˜ˆì™¸ ë°œìƒ ìƒê´€ì—†ì´ ì‹¤í–‰í•˜ëŠ” Advice
  - After Returning + After Throwing
- **Around**
  - ìœ„ ë„¤ê°€ì§€ Adviceë¥¼ ëª¨ë‘ í¬í•¨, ëª¨ë“  ì‹œì ì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” Advice

![image-20230320002412947](./image-20230320002412947.png)





### ğŸ“Œ AOP êµ¬í˜„ ë°©ë²•

1. ì»´íŒŒì¼ ì‹œì ì— ì½”ë“œì— ê³µí†µ ê¸°ëŠ¥ì„ ì‚½ì…í•˜ëŠ” ë°©ë²•
2. í´ë˜ìŠ¤ ë¡œë”© ì‹œì ì— ë°”ì´íŠ¸ ì½”ë“œì— ê³µí†µ ê¸°ëŠ¥ì„ ì‚½ì…í•˜ëŠ” ë°©ë²•
3. **ëŸ°íƒ€ì„ì— í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ê³µí†µ ê¸°ëŠ¥ì„ ì‚½ì…í•˜ëŠ” ë°©ë²•**



### ğŸ“Œ ìŠ¤í”„ë§ AOP íŠ¹ì§•

1. **í”„ë¡ì‹œ ê¸°ë°˜**ì˜ AOP êµ¬í˜„ì²´
2. ìŠ¤í”„ë§ ë¹ˆì—ë§Œ AOP ë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤.
3. ë™ì  í”„ë¡ì‹œ ë¹ˆì„ ë§Œë“¤ì–´ ë“±ë¡ì‹œì¼œì¤€ë‹¤.



### ğŸ“Œ í”„ë¡ì‹œ íŒ¨í„´

- ì‹¤ì œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ê°ì²´ ëŒ€ì‹  ê°€ìƒì˜ ê°ì²´(proxy object)ë¥¼ ì‚¬ìš©í•´ ë¡œì§ì˜ íë¦„ì„ ì œì–´í•˜ëŠ” ë””ìì¸ íŒ¨í„´.
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ íƒ€ê²Ÿì„ í˜¸ì¶œí•˜ê²Œ ë˜ë©´ íƒ€ê²Ÿì´ ì•„ë‹Œ íƒ€ê²Ÿì„ ê°ì‹¸ê³  ìˆëŠ” í”„ë¡ì‹œê°€ í˜¸ì¶œë˜ì–´, íƒ€ê²Ÿ ë©”ì†Œë“œ ì‹¤í–‰ ì „ì— ì„ ì²˜ë¦¬, íƒ€ì¼“ ë©”ì†Œë“œ ì‹¤í–‰ í›„ í›„ì²˜ë¦¬ë¥¼ ì‹¤í–‰ì‹œí‚¤ë„ë¡ êµ¬ì„±ë˜ì–´ ìˆìŒ.
- AOPì—ì„œ í”„ë¡ì‹œëŠ” í˜¸ì¶œì„ ê°€ë¡œì±ˆ í›„, ì–´ë“œë°”ì´ìŠ¤ì— ë“±ë¡ëœ ê¸°ëŠ¥ì„ ìˆ˜í–‰ í›„ íƒ€ê²Ÿ ë©”ì„œë“œë¥¼ ì‹¤í–‰.

<img src="./image-20230320001806575.png" alt="image-20230320001806575" style="zoom:50%;" />



### ğŸ“Œ AOP êµ¬í˜„ ì˜ˆì œ

#### ğŸ¥ ì¤€ë¹„

```java
// ì˜ì¡´ì„± ì£¼ì…

<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

```java
// ê°„ë‹¨í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ í•˜ë‚˜ë¥¼ ë¹ˆìœ¼ë¡œ ì •ì˜

public interface EventService {
  public void created();
  public void operation();
  public void deleted();
}

```

```java
@Component
public class SimpleServiceEvent implements EventService {

  @Override
  public void created() {
    long begin = System.currentTimeMillis();
    try {
      Thread.sleep(1000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    System.out.println("created");
    System.out.println(System.currentTimeMillis() - begin);
  }

  @Override
  public void operation() {
    System.out.println(System.currentTimeMillis() - begin);
    try {
      Thread.sleep(2000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    System.out.println("operation");
    System.out.println(System.currentTimeMillis() - begin);

  }

  @Override
  public void deleted() {
    System.out.println("deleted");
  }
}
```

```java
@Component
public class AppRuner implements ApplicationRunner {

  @Autowired
  EventService eventService;

  @Override
  public void run(ApplicationArguments args) throws Exception {
    eventService.created();
    eventService.operation();
    eventService.deleted();
  }
}
```



#### ğŸ¥ ì‹¤í–‰ê²°ê³¼

```
created
1011
operation
2004
deleted
```



### ğŸ¥ AOP ì ìš©í•˜ê¸°

```java
// ìœ„ ì½”ë“œì—ì„œëŠ” ìˆ˜í–‰ ì‹œê°„ì„ ì¬ëŠ” ì•„ë˜ ì½”ë“œê°€ ì—¬ëŸ¬ ê³³ì—ì„œ ë°˜ë³µ ì‚¬ìš©ë˜ê³  ìˆìŒ

long begin = System.currentTimeMillis();
... (ìˆ˜í–‰) ...
System.out.println(System.currentTimeMillis() - begin);
```

```java
// ìœ„ ì½”ë“œë¥¼ í•˜ë‚˜ë¡œ ë¬¶ê¸°
// Aspect ì •ì˜
@Component
@Aspect
public class PerfAspect {

  // Advice ì •ì˜ (Around ì‚¬ìš©)
  // Point Cut í‘œí˜„ì‹
  // (com.example.demo ë°‘ì— ìˆëŠ” ëª¨ë“  í´ë˜ìŠ¤ ì¤‘ EventService ì•ˆì— ë“¤ì–´ìˆëŠ” ëª¨ë“  ë©”ì˜ë“œì— ì´ í–‰ìœ„ë¥¼ ì ìš©í•˜ë¼.)
  @Around("execution(* com.example..*.EventService.*(..))")
  public Object logPerf(ProceedingJoinPoint pjp) throws Throwable {
    long begin = System.currentTimeMillis();
    Object retVal = pjp.proceed();
    System.out.println(System.currentTimeMillis() - begin);
    return retVal;
  }
}
```

```java
// AOPë¥¼ ìœ„ ì½”ë“œì—ì„œ ì ìš©í–ˆìœ¼ë¯€ë¡œ, ìˆ˜í–‰ì‹œê°„ ì¶œë ¥ ë¶€ë¶„ ì½”ë“œ ì‚­ì œ

@Component
public class SimpleServiceEvent implements EventService {

  @Override
  public void created() {
    try {
      Thread.sleep(1000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    System.out.println("created");
  }

  @Override
  public void operation() {
    try {
      Thread.sleep(2000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    System.out.println("operation");
  }

  @Override
  public void deleted() {
    System.out.println("deleted");
  }
}
```



#### ğŸ¥ ì‹¤í–‰ê²°ê³¼

```
created
1011
operation
2004
deleted
3000
```



#### ğŸ¥ Annotation ê¸°ë°˜

- ë‚˜ëŠ” `created()` ì™€ `operation()`ì—ë§Œ ì ìš©í•˜ê³  ì‹¶ì€ë° `delete()`ì—ë„ ì ìš©ì´ ëë‹¤ !
- ì´ë¥¼ Annotation ê¸°ë°˜ Advice ì •ì˜ë¡œ í•´ê²°í•˜ê¸°

```java
// Annotation ë§Œë“¤ê¸°

@Documented
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.CLASS)
public @interface PerfLogging {
}
```

```java
// Aspect í´ë˜ìŠ¤ ìˆ˜ì •

@Component
@Aspect
public class PerfAspect {

  // PerfLogging ì–´ë…¸í…Œì´ì…˜ì´ ë‹¬ë¦° ê³³ë§Œ í¬ì¸íŠ¸ì»· ìˆ˜ì •
  @Around("@annotation(PerfLogging)")
  public Object logPerf(ProceedingJoinPoint pjp) throws Throwable {
    long begin = System.currentTimeMillis();
    Object retVal = pjp.proceed();
    System.out.println(System.currentTimeMillis() - begin);
    return retVal;
  }
}
```

```java
// class method ìˆ˜ì •

@Component
public class SimpleServiceEvent implements EventService {

  @PerfLogging
  @Override
  public void created() {
    ...
  }

  @PerfLogging
  @Override
  public void operation() {
    ...
  }

  @Override
  public void deleted() {
    ...
  }
}
```



#### ğŸ¥ ì¶œë ¥ ê²°ê³¼

```
created
1011
operation
2004
deleted
```



### ğŸ“Œ í”„ë¡ì‹œ íŒ¨í„´ íŠ¹ì§• ì˜ˆì œ

```java
package org.springframework.samples.petclinic.proxy;

public interface Payment {
    void pay(int amount);
}
```

```java
package org.springframework.samples.petclinic.proxy;

public class Cash implements Payment{

    public void pay(int amount){
        System.out.println(amount + " í˜„ê¸ˆ ê²°ì œ");
    }
}
```

```java
package org.springframework.samples.petclinic.proxy;

import org.springframework.util.StopWatch;

//í”„ë¡ì‹œ í´ë˜ìŠ¤
public class CashPerf implements Payment{

    Payment cash = new Cash();
    
    @Override
    public void pay(int amount) {
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();

        cash.pay(amount);

        stopWatch.stop();
        System.out.println(stopWatch.prettyPrint());

    }
}
```

```java
package org.springframework.samples.petclinic.proxy;

public class Store {

    Payment payment;

    public Store(Payment payment) {
        this.payment = payment;
    }

    public void butSomething(int amount){
        payment.pay(amount);
    }
}
```

```java
package org.springframework.samples.petclinic.proxy;

import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

class StoreTest {


    //Cash í´ë˜ìŠ¤ì™€ Storeí´ë˜ìŠ¤ëŠ” ë°”ë€Œì§€ ì•Šì•˜ì§€ë§Œ ì´ ì½”ë“œ ì•ë’¤ë¡œ ì„±ëŠ¥ ì¸¡ì •ì„ í•˜ë„ë¡ í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ì´ìš©í•¨.
    @Test
    public void testPay(){
        Payment cashPerf = new Cash();
        Store store = new Store(cashPerf);
        store.butSomething(100);
    }
}
```



### ğŸ“Œ ì°¸ê³ 

https://dailyheumsi.tistory.com/202

https://dong-co.tistory.com/84

https://code-lab1.tistory.com/193